<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Vinnar Institution of Fashion Design</title>
    <link rel="icon" href="tab-icon.jpeg" type="image/jpeg">
    <!-- Use Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <!-- Sidebar -->
    <aside>
        <div class="logo-section">
            <span>Vinnar Portal</span>
        </div>
        <nav>
            <ul>
                <li id="menuDashboard" class="active" onclick="showPage('dashboard')"><i class="fas fa-chart-line"></i>
                    Dashboard</li>
                <li id="menuStudents" onclick="showPage('students')"><i class="fas fa-user-graduate"></i> Students</li>
                <li id="menuReports" onclick="showPage('reports')"><i class="fas fa-file-export"></i> Reports</li>
                <li id="menuExams" onclick="showPage('exams')"><i class="fas fa-graduation-cap"></i> Exams</li>
                <li id="menuSettings" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</li>
                <li onclick="logout()" style="margin-top: 10rem;"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </nav>
        <div style="padding: 1rem 1.5rem; font-size: 0.7rem; opacity: 0.6; color: white;">
            Developed by <a href="https://sswebtech.xyz" target="_blank"
                style="color: white; font-weight: 700;">SSWebTech</a>
        </div>
    </aside>

    <!-- Main -->
    <main>
        <header>
            <h1 id="headerTitle"><i class="fas fa-tachometer-alt" style="color: var(--card-blue);"></i> Overview</h1>
            <div class="flex-center">
                <div class="user-avatar">A</div>
            </div>
        </header>

        <div class="content-area">

            <!-- Dashboard Section -->
            <div id="sectionDashboard" class="page-section active">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total Students</h4>
                        <div class="value" id="statTotalStudents">0</div>
                        <div class="icon-box"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-card">
                        <h4>Checked In Today</h4>
                        <div class="value" id="statCheckedIn">0</div>
                        <div class="icon-box"><i class="fas fa-user-check"></i></div>
                    </div>
                    <div class="stat-card" style="background: #0891b2;">
                        <h4>Checked Out</h4>
                        <div class="value" id="statCheckedOut">0</div>
                        <div class="icon-box"><i class="fas fa-sign-out-alt"></i></div>
                    </div>
                    <div class="stat-card" style="background: #f59e0b;">
                        <h4>Pending</h4>
                        <div class="value" id="statPending">0</div>
                        <div class="icon-box"><i class="fas fa-clock"></i></div>
                    </div>
                </div>

                <!-- Management Section -->
                <div class="mgmt-panel">
                    <div class="mgmt-card">
                        <h3><i class="fas fa-user-plus"></i> Add New Student</h3>
                        <form id="addStudentForm">
                            <input type="text" id="fullName" placeholder="Full Student Name" required>
                            <input type="text" id="username" placeholder="Username (Login ID)" required>
                            <input type="password" id="password" placeholder="Passkey" required>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                <input type="number" id="dueAmount" placeholder="Due Amt (₹)">
                                <input type="date" id="dueDate" placeholder="Due Date">
                                <input type="number" id="paidFees" placeholder="Paid (₹)">
                            </div>
                            <!-- feeStatus input removed -->
                            <input type="text" id="feeRemarks" placeholder="Fee Remarks (e.g. Next pay 10th)">
                            <input type="text" id="recordStatus" placeholder="Record Status (e.g. Pending)">
                            <input type="text" id="pendingDocs" placeholder="Missing Docs (e.g. Aadhar, Photo)">
                            <input type="text" id="parentPhone"
                                placeholder="Parent WhatsApp Number (e.g. 919876543210)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="batch" placeholder="Batch (e.g. 2024-25)">
                                <select id="assignedShift" required>
                                    <option value="">Assign Shift</option>
                                    <option value="morning">Morning (9am-1pm)</option>
                                    <option value="afternoon">Afternoon (1pm-5pm)</option>
                                    <option value="fulltime">Full Time (9am-5pm)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary"
                                style="width: 100%; justify-content: center;">Register Member</button>
                        </form>
                    </div>

                    <div class="mgmt-card flex-center flex-column">
                        <h3><i class="fas fa-qrcode"></i> Institution Access QR</h3>
                        <img src="qr-code.jpg" alt="Attendance QR Code"
                            style="width: 160px; height: 160px; border-radius: 10px; margin-bottom: 10px;">
                        <div class="qr-code-box">
                            Scan to Mark Attendance
                        </div>
                    </div>
                </div>

                <!-- Activity -->
                <div class="data-card">
                    <h3><i class="fas fa-history"></i> Today's Activity</h3>
                    <div style="overflow-x: auto;">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Time (In / Out)</th>
                                    <th>Verification Photos</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="sectionStudents" class="page-section">
                <!-- All Students -->
                <div class="data-card">
                    <h3><i class="fas fa-users" style="color: var(--card-blue);"></i> Registered Students</h3>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Login ID</th>
                                    <th>Assigned Shift</th>
                                    <th>Batch</th>
                                    <th>Financials</th>
                                    <th>Record Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="allStudentsList"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="sectionReports" class="page-section">
                <div class="mgmt-card mb-15">
                    <div class="flex gap-15" style="align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <label class="form-group label">Batch (Optional)</label>
                            <select id="reportBatchSelect" style="margin-bottom: 0;">
                                <option value="">All Batches</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label class="form-group label">Student (Optional)</label>
                            <select id="reportStudentSelect" style="margin-bottom: 0;">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label class="form-group label">Start Date</label>
                            <input type="date" id="reportStartDate" style="margin-bottom: 0;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label class="form-group label">End Date</label>
                            <input type="date" id="reportEndDate" style="margin-bottom: 0;">
                        </div>
                        <button class="btn btn-primary" style="padding: 0.75rem 1.5rem;" onclick="loadReportPreview()">
                            <i class="fas fa-sync-alt"></i> Generate Preview
                        </button>
                        <button id="downloadCSVBtn" class="btn btn-primary"
                            style="padding: 0.75rem 1.5rem; background: #059669; display: none;"
                            onclick="downloadExcel()">
                            <i class="fas fa-file-excel"></i> Download Excel
                        </button>
                    </div>
                </div>

                <div class="data-card">
                    <h3><i class="fas fa-table" style="color: var(--card-blue);"></i> Report Preview</h3>
                    <div style="overflow-x: auto; max-height: 600px;">
                        <table id="reportPreviewTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Name</th>
                                    <th>Batch</th>
                                    <th>Shift</th>
                                    <th>Status</th>
                                    <th>In Time</th>
                                    <th>Out Time</th>
                                    <th>Photos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6"
                                        style="text-align: center; padding: 3rem; color: var(--text-light);">Select a
                                        month and click 'Generate Preview'</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Exams Section -->
            <div id="sectionExams" class="page-section">
                <div class="mgmt-card mb-15">
                    <h3><i class="fas fa-plus-circle" style="color: var(--card-blue);"></i> Add Exam Results</h3>
                    <form id="addExamForm">
                        <div class="flex gap-15" style="flex-wrap: wrap; margin-bottom: 15px;">
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-group label">Student</label>
                                <select id="examStudentSelect" required style="margin-bottom: 0;">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label class="form-group label">Exam Month</label>
                                <input type="month" id="examMonth" required style="margin-bottom: 0;">
                            </div>
                        </div>

                        <div id="subjectsContainer">
                            <div class="subject-row flex gap-10" style="align-items: flex-end; margin-bottom: 10px;">
                                <div style="flex: 2;">
                                    <label class="form-group label">Subject</label>
                                    <select name="subjectName" required style="margin-bottom: 0;">
                                        <option value="" disabled selected>Select Subject</option>
                                        <option value="Illustration">Illustration</option>
                                        <option value="Pattern Making">Pattern Making</option>
                                        <option value="Embroidery">Embroidery</option>
                                        <option value="Art & Craft">Art & Craft</option>
                                        <option value="Beautician">Beautician</option>
                                        <option value="Communicative English">Communicative English</option>
                                        <option value="CAD">CAD</option>
                                        <option value="Others">Others</option>
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label class="form-group label">Marks</label>
                                    <input type="number" name="marksObtained" placeholder="Obtained" required
                                        style="margin-bottom: 0;">
                                </div>
                                <div style="flex: 1;">
                                    <label class="form-group label">Total</label>
                                    <input type="number" name="totalMarks" value="100" required
                                        style="margin-bottom: 0;">
                                </div>
                                <button type="button" class="btn btn-ghost" onclick="removeSubjectRow(this)"
                                    style="color: #ef4444; padding: 5px;"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="addSubjectRow()"
                            style="margin-bottom: 15px; color: var(--card-blue); padding: 0;">
                            <i class="fas fa-plus"></i> Add Another Subject
                        </button>

                        <div class="form-group">
                            <label class="form-group label">Remarks</label>
                            <input type="text" id="examRemarks" placeholder="e.g. Excellent improvement in sketching!">
                        </div>

                        <button type="submit" class="btn btn-primary w-full flex-center">
                            <i class="fas fa-save" style="margin-right: 8px;"></i> Save Results
                        </button>
                    </form>
                </div>

                <div class="data-card">
                    <h3><i class="fas fa-list-alt" style="color: var(--card-blue);"></i> Recent Results</h3>
                    <div class="flex gap-15"
                        style="margin-bottom: 20px; flex-wrap: wrap; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="flex: 1; min-width: 150px;">
                            <label class="text-small text-bold"
                                style="color: var(--text-light); margin-bottom: 5px; display: block;">Filter by
                                Batch</label>
                            <select id="listBatchSelect" onchange="filterExamList()"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; outline: none;">
                                <option value="">All Batches</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label class="text-small text-bold"
                                style="color: var(--text-light); margin-bottom: 5px; display: block;">Filter by
                                Student</label>
                            <select id="listStudentSelect" onchange="filterExamList()"
                                style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; outline: none;">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label class="text-small text-bold"
                                style="color: var(--text-light); margin-bottom: 5px; display: block;">Filter by
                                Month</label>
                            <input type="month" id="listMonthFilter" onchange="filterExamList()"
                                style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; outline: none; margin-bottom: 0;">
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="examResultsTable">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Student</th>
                                    <th>Subjects</th>
                                    <th>Result</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem;">Select a student to view
                                        results</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="sectionSettings" class="page-section">
                <div class="mgmt-card" style="max-width: 500px; margin: 0 auto;">
                    <h3><i class="fas fa-key" style="color: var(--card-blue);"></i> Security Settings</h3>
                    <p style="color: var(--text-light); font-size: 0.85rem; margin-bottom: 2rem;">Manage your
                        administrative access and update your secure passkey.</p>

                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label class="text-bold text-small" style="display: block; margin-bottom: 8px;">Active
                                Passkey</label>
                            <input type="password" id="currentPassword" placeholder="Enter current password" required>
                        </div>
                        <div class="form-group">
                            <label class="text-bold text-small" style="display: block; margin-bottom: 8px;">New Secure
                                Passkey</label>
                            <input type="password" id="newPassword" placeholder="Minimum 6 characters" required
                                minlength="6" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label class="text-bold text-small" style="display: block; margin-bottom: 8px;">Verify New
                                Passkey</label>
                            <input type="password" id="confirmPassword" placeholder="Repeat new password" required
                                minlength="6" autocomplete="new-password">
                        </div>

                        <div id="settingsStatus" class="text-small"
                            style="margin-bottom: 1rem; display: none; padding: 10px; border-radius: 8px;"></div>

                        <button type="submit" class="btn btn-primary w-full flex-center">
                            <i class="fas fa-save" style="margin-right: 8px;"></i> Update Security Credentials
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Edit Student Modal -->
    <div id="editModalOverlay" class="modal-overlay">
        <div class="edit-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit" style="color: var(--card-blue);"></i> Edit Student Details</h2>
                <button class="close-modal" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="editStudentForm" style="padding: 0;">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="editFullName" required>
                </div>
                <div class="edit-form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>Due Amount (₹)</label>
                        <input type="number" id="editDueAmount">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="editDueDate">
                    </div>
                    <div class="form-group">
                        <label>Paid Fees (₹)</label>
                        <input type="number" id="editPaidFees">
                    </div>
                </div>
                <!-- feeStatus input removed -->
                <div class="form-group">
                    <label>Fee Remarks (Private)</label>
                    <input type="text" id="editFeeRemarks" placeholder="Internal notes...">
                </div>
                <div class="edit-form-grid">
                    <div class="form-group">
                        <label>Record Status</label>
                        <input type="text" id="editRecordStatus" placeholder="e.g. Pending">
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <input type="text" id="editBatch" placeholder="e.g. 2024-25">
                    </div>
                    <div class="form-group">
                        <label>Assigned Shift</label>
                        <select id="editAssignedShift">
                            <option value="morning">Morning</option>
                            <option value="afternoon">Afternoon</option>
                            <option value="fulltime">Full Time</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>New Password (Leave blank to keep current)</label>
                    <input type="password" id="editPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label>Missing Documents</label>
                    <input type="text" id="editPendingDocs" placeholder="e.g. Aadhar, Passport Photo">
                </div>
                <div class="form-group">
                    <label>Parent WhatsApp Number</label>
                    <input type="text" id="editParentPhone" placeholder="e.g. 919876543210">
                </div>
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 1rem;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div id="viewPhotoModal" class="modal-overlay" onclick="closePhotoModal()">
        <button class="photo-close-btn" onclick="closePhotoModal()"><i class="fas fa-times"></i></button>
        <div class="edit-modal">
            <img id="fullPhoto" src="" class="photo-full-view">
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'index.html';
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            let cleaned = phone.replace(/\D/g, ''); // Remove non-digits

            // Auto-fix 10 digit numbers
            if (cleaned.length === 10) {
                cleaned = '91' + cleaned;
            }

            // Validation: Must be 12 digits starting with 91 (India)
            if (cleaned.length !== 12 || !cleaned.startsWith('91')) {
                return null;
            }
            return cleaned;
        }

        function showPage(page) {
            // Toggle sections
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.add('active');

            // Toggle Sidebar menu
            document.querySelectorAll('nav li').forEach(li => li.classList.remove('active'));
            document.getElementById(`menu${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.add('active');

            // Update Header
            if (page === 'dashboard') {
                document.getElementById('headerTitle').innerHTML = '<i class="fas fa-tachometer-alt" style="color: var(--card-blue);"></i> Overview';
                loadDashboardData();
            } else if (page === 'students') {
                document.getElementById('headerTitle').innerHTML = '<i class="fas fa-user-graduate" style="color: var(--card-blue);"></i> Student Management';
                loadStudentsList();
            } else if (page === 'reports') {
                document.getElementById('headerTitle').innerHTML = '<i class="fas fa-file-invoice" style="color: var(--card-blue);"></i> Attendance Reports';
                // Set default dates (Today)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('reportStartDate').value = today;
                document.getElementById('reportEndDate').value = today;
            } else if (page === 'exams') {
                document.getElementById('headerTitle').innerHTML = '<i class="fas fa-graduation-cap" style="color: var(--card-blue);"></i> Exam Results';
                loadExamsData();
            } else if (page === 'settings') {
                document.getElementById('headerTitle').innerHTML = '<i class="fas fa-user-lock" style="color: var(--card-blue);"></i> Account Settings';
            }
        }

        let allExamResultsCache = [];

        async function loadExamsData() {
            try {
                // Populate Student Dropdown (Top Form)
                const res = await fetch('/api/all-students');
                const students = await res.json();

                const select = document.getElementById('examStudentSelect');
                select.innerHTML = '<option value="">Select Student</option>';
                students.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s._id;
                    opt.innerText = `${s.fullName} (${s.username})`;
                    select.appendChild(opt);
                });

                // Load All Results for Bottom List
                loadAllExamResults();

            } catch (err) {
                console.error('Error loading exams data', err);
            }
        }

        async function loadAllExamResults() {
            try {
                const res = await fetch('/api/all-exam-results');
                allExamResultsCache = await res.json();

                // Populate Filter Dropdowns
                const uniqueBatches = [...new Set(allExamResultsCache.map(r => r.studentId ? r.studentId.batch : '').filter(b => b))];
                const uniqueStudents = [...new Map(allExamResultsCache.map(r => [r.studentId?._id, r.studentId])).values()].filter(s => s && s._id);

                const batchSel = document.getElementById('listBatchSelect');
                const studentSel = document.getElementById('listStudentSelect');

                // Keep selections if re-loading
                const currBatch = batchSel.value;
                const currStudent = studentSel.value;

                batchSel.innerHTML = '<option value="">All Batches</option>';
                uniqueBatches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.innerText = b;
                    if (b === currBatch) opt.selected = true;
                    batchSel.appendChild(opt);
                });

                studentSel.innerHTML = '<option value="">All Students</option>';
                uniqueStudents.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s._id;
                    opt.innerText = `${s.fullName} (${s.username})`;
                    if (s._id === currStudent) opt.selected = true;
                    studentSel.appendChild(opt);
                });

                filterExamList();

            } catch (err) { console.error(err); }
        }

        function filterExamList() {
            const batchFilter = document.getElementById('listBatchSelect').value;
            const studentFilter = document.getElementById('listStudentSelect').value;
            const monthFilter = document.getElementById('listMonthFilter').value;
            const tbody = document.querySelector('#examResultsTable tbody');

            let filtered = allExamResultsCache;

            if (batchFilter) {
                filtered = filtered.filter(r => r.studentId && r.studentId.batch === batchFilter);
            }
            if (studentFilter) {
                filtered = filtered.filter(r => r.studentId && r.studentId._id === studentFilter);
            }
            if (monthFilter) {
                filtered = filtered.filter(r => r.examMonth === monthFilter);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No matching results found.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            filtered.forEach(r => {
                if (!r.studentId) return; // Skip if student deleted
                const dateObj = new Date(r.examMonth + '-01');
                const monthStr = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
                const subList = r.subjects.map(s => `<div class="text-small">${s.subjectName} <span class="text-muted">(${s.marksObtained})</span></div>`).join('');

                tbody.innerHTML += `
                    <tr>
                        <td>${monthStr}</td>
                        <td>
                            <div class="text-bold">${r.studentId.fullName}</div>
                            <div class="text-small text-muted">${r.studentId.batch || '-'}</div>
                        </td>
                        <td>${subList}</td>
                        <td>
                            <div class="text-bold">${r.totalPercentage.toFixed(1)}%</div>
                            <div class="text-small text-muted">"${r.remarks}"</div>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" style="background-color: #25D366; color: white; border: none; margin-bottom: 5px; width: 100%;" 
                                onclick='sendWhatsAppReport(${JSON.stringify(r).replace(/'/g, "&apos;")}, "${r.studentId.fullName.replace(/'/g, "&apos;")}")'>
                                <i class="fab fa-whatsapp"></i> Send
                            </button>
                            <button class="btn btn-ghost btn-sm" style="color: var(--card-blue); width: 100%; border: 1px solid var(--card-blue); margin-bottom: 5px;"
                                onclick='editExamResult(${JSON.stringify(r).replace(/'/g, "&apos;")})'>
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-ghost btn-sm" style="color: #ef4444; width: 100%; border: 1px solid #ef4444;"
                                onclick='deleteExamResult("${r._id}")'>
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function addSubjectRow() {
            const div = document.createElement('div');
            div.className = 'subject-row flex gap-10';
            div.style.alignItems = 'flex-end';
            div.style.marginBottom = '10px';
            div.innerHTML = `
                <div style="flex: 2;">
                    <select name="subjectName" required style="margin-bottom: 0;">
                        <option value="" disabled selected>Select Subject</option>
                        <option value="Illustration">Illustration</option>
                        <option value="Pattern Making">Pattern Making</option>
                        <option value="Embroidery">Embroidery</option>
                        <option value="Art & Craft">Art & Craft</option>
                        <option value="Beautician">Beautician</option>
                        <option value="Communicative English">Communicative English</option>
                        <option value="CAD">CAD</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <input type="number" name="marksObtained" placeholder="Obtained" required style="margin-bottom: 0;">
                </div>
                <div style="flex: 1;">
                    <input type="number" name="totalMarks" value="100" required style="margin-bottom: 0;">
                </div>
                <button type="button" class="btn btn-ghost" onclick="removeSubjectRow(this)" style="color: #ef4444; padding: 5px;"><i class="fas fa-trash"></i></button>
            `;
            document.getElementById('subjectsContainer').appendChild(div);
        }

        function removeSubjectRow(btn) {
            if (document.querySelectorAll('.subject-row').length > 1) {
                btn.parentElement.remove();
            } else {
                alert("At least one subject is required.");
            }
        }

        document.getElementById('addExamForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const subjects = [];
                let totalObtained = 0;
                let maxMarks = 0;

                document.querySelectorAll('.subject-row').forEach(row => {
                    const name = row.querySelector('select[name="subjectName"]').value;
                    const obt = Number(row.querySelector('input[name="marksObtained"]').value);
                    const tot = Number(row.querySelector('input[name="totalMarks"]').value);
                    subjects.push({ subjectName: name, marksObtained: obt, totalMarks: tot });
                    totalObtained += obt;
                    maxMarks += tot;
                });

                const percentage = (totalObtained / maxMarks) * 100;

                const payload = {
                    studentId: document.getElementById('examStudentSelect').value,
                    examMonth: document.getElementById('examMonth').value,
                    subjects: subjects,
                    totalPercentage: percentage,
                    remarks: document.getElementById('examRemarks').value
                };

                const res = await fetch('/api/exam-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('Exam result saved/updated!');
                    document.getElementById('addExamForm').reset();
                    // Reset subjects container to default single row
                    document.getElementById('subjectsContainer').innerHTML = '';
                    addSubjectRow();
                    // Trigger change event to reload table
                    document.getElementById('examStudentSelect').dispatchEvent(new Event('change'));

                    // Reset Title
                    document.querySelector('#sectionExams h3').innerHTML = '<i class="fas fa-plus-circle" style="color: var(--card-blue);"></i> Add Exam Results';

                } else {
                    alert('Error saving result');
                }
            } catch (err) { console.error(err); alert('Error saving'); }
            finally {
                btn.innerHTML = '<i class="fas fa-save" style="margin-right: 8px;"></i> Save Results';
                btn.disabled = false;
            }
        };

        function editExamResult(r) {
            // 1. Set Month
            document.getElementById('examMonth').value = r.examMonth;

            // 2. Set Remarks
            document.getElementById('examRemarks').value = r.remarks;

            // 3. Clear and Rebuild Subjects
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '';

            r.subjects.forEach(sub => {
                const div = document.createElement('div');
                div.className = 'subject-row flex gap-10';
                div.style.alignItems = 'flex-end';
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <div style="flex: 2;">
                        <select name="subjectName" required style="margin-bottom: 0;">
                            <option value="" disabled>Select Subject</option>
                            <option value="Illustration" ${sub.subjectName === 'Illustration' ? 'selected' : ''}>Illustration</option>
                            <option value="Pattern Making" ${sub.subjectName === 'Pattern Making' ? 'selected' : ''}>Pattern Making</option>
                            <option value="Embroidery" ${sub.subjectName === 'Embroidery' ? 'selected' : ''}>Embroidery</option>
                            <option value="Art & Craft" ${sub.subjectName === 'Art & Craft' ? 'selected' : ''}>Art & Craft</option>
                            <option value="Beautician" ${sub.subjectName === 'Beautician' ? 'selected' : ''}>Beautician</option>
                            <option value="Communicative English" ${sub.subjectName === 'Communicative English' ? 'selected' : ''}>Communicative English</option>
                            <option value="CAD" ${sub.subjectName === 'CAD' ? 'selected' : ''}>CAD</option>
                            <option value="Others" ${sub.subjectName === 'Others' ? 'selected' : ''}>Others</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <input type="number" name="marksObtained" value="${sub.marksObtained}" placeholder="Obtained" required style="margin-bottom: 0;">
                    </div>
                    <div style="flex: 1;">
                        <input type="number" name="totalMarks" value="${sub.totalMarks}" required style="margin-bottom: 0;">
                    </div>
                    <button type="button" class="btn btn-ghost" onclick="removeSubjectRow(this)" style="color: #ef4444; padding: 5px;"><i class="fas fa-trash"></i></button>
                 `;
                container.appendChild(div);
            });

            // If "Others" or different subjects were used that are not in list, handle gracefully (optional, but above assumes standard list)

            // Scroll to top
            document.querySelector('.mgmt-panel').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('examMonth').focus();

            // Change Title to indicate Edit mode
            document.querySelector('#sectionExams h3').innerHTML = '<i class="fas fa-edit" style="color: var(--card-blue);"></i> Edit Exam Results';

            alert("Loaded result for editing. Make changes and click 'Save Results' to update.");
        }

        async function deleteExamResult(id) {
            if (!confirm("Are you sure you want to delete this exam result? This cannot be undone.")) return;
            try {
                const res = await fetch(`/api/exam-results/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Exam result deleted successfully.');
                    // Refresh List
                    document.getElementById('examStudentSelect').dispatchEvent(new Event('change'));

                    // Reset Form if it was in edit mode for this item (optional, but good practice)
                    document.getElementById('addExamForm').reset();
                    document.querySelector('#sectionExams h3').innerHTML = '<i class="fas fa-plus-circle" style="color: var(--card-blue);"></i> Add Exam Results';
                    document.getElementById('subjectsContainer').innerHTML = '';
                    addSubjectRow();

                } else {
                    alert('Error deleting result.');
                }
            } catch (err) { console.error(err); alert('Connection error'); }
        }



        async function sendWhatsAppReport(result, studentName) {
            try {
                // Get student details to find parent phone
                const studentId = result.studentId._id || result.studentId;
                const sRes = await fetch(`/api/students/${studentId}`);
                const student = await sRes.json();

                if (!student.parentPhone) {
                    alert("Parent phone number not found for this student. Please update student details.");
                    return;
                }

                // Get Attendance Data
                const [year, month] = result.examMonth.split('-');
                const startDate = `${year}-${month}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${year}-${month}-${lastDay}`;

                const attRes = await fetch(`/api/attendance/range-report?startDate=${startDate}&endDate=${endDate}&studentId=${result.studentId._id || result.studentId}`);
                const attendanceRecords = await attRes.json();
                const presentDays = attendanceRecords.filter(a => a.checkInTime).length;

                // Calculate Working Days based on ANY attendance on a given day (Dynamic)
                // Fetch ALL attendance for this month (no studentId filter)
                const allAttRes = await fetch(`/api/attendance/range-report?startDate=${startDate}&endDate=${endDate}`);
                const allAttendanceRecords = await allAttRes.json();

                // Get unique dates where ANYONE was present
                const uniqueWorkingDates = new Set(allAttendanceRecords.map(r => r.date.split('T')[0]));
                const estimatedWorkingDays = uniqueWorkingDates.size;

                const attendancePercent = estimatedWorkingDays > 0 ? ((presentDays / estimatedWorkingDays) * 100).toFixed(1) : 0;

                const monthFormatted = new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });

                let msg = `Vinnar Institution of Fashion Design\nMonthly Progress Report\n\n`;
                msg += `Student: ${studentName}\n`;
                msg += `Month: ${monthFormatted}\n\n`;

                msg += `Performance:\n`;
                result.subjects.forEach(sub => {
                    msg += `• ${sub.subjectName}: ${sub.marksObtained}/${sub.totalMarks}\n`;
                });
                msg += `\nTotal Percentage: ${result.totalPercentage.toFixed(1)}%\n`;

                msg += `\nAttendance (Monthly):\n`;
                msg += `• Working Days: ${estimatedWorkingDays}\n`;
                msg += `• Days Present: ${presentDays}\n`;
                msg += `• Approx. Attendance: ${attendancePercent}%\n`;

                if (student.dueAmount > 0) {
                    msg += `\nFees Details:\n`;
                    msg += `• Due Amount: ₹${student.dueAmount}\n`;
                    if (student.dueDate) {
                        const dDate = new Date(student.dueDate).toLocaleDateString('en-GB');
                        msg += `• Due Date: ${dDate}\n`;
                    }
                } else {
                    msg += `\nFees: Paid\n`;
                }

                msg += `\nRemarks: ${result.remarks}\n\n`;
                msg += `This is an automated report from Vinnar Portal.`;

                const url = `https://wa.me/${student.parentPhone}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');

            } catch (err) {
                console.error(err);
                alert("Error generating WhatsApp link.");
            }
        }

        async function loadStudentsList() {
            try {
                const res = await fetch('/api/all-students');
                const students = await res.json();

                const listBody = document.getElementById('allStudentsList');
                listBody.innerHTML = '';

                students.forEach(student => {
                    listBody.innerHTML += `
                        <tr>
                            <td><div class="text-bold">${student.fullName}</div></td>
                            <td><div class="text-mono text-muted" style="text-transform: uppercase;">${student.username}</div></td>
                            <td><span class="badge badge-info">${student.assignedShift || 'morning'}</span></td>
                            <td><span class="text-small text-muted">${student.batch || '-'}</span></td>
                            <td>
                                <!-- Fee Status text removed -->
                                <!-- Fee Status text removed -->
                                <div class="text-small text-muted">Amnt: ₹${student.dueAmount || 0} | Due: ${student.dueDate ? student.dueDate.split('-').reverse().join('-') : '-'}</div>
                                ${student.feeRemarks ? `<div class="text-small text-muted" style="font-style: italic;">"${student.feeRemarks}"</div>` : ''}
                            </td>
                            <td>
                                <div class="text-bold ${student.recordStatus === 'All Clear' ? 'text-success' : 'text-warning'}">${student.recordStatus || 'All Clear'}</div>
                                ${student.pendingDocs ? `<div class="text-small text-danger">Missing: ${student.pendingDocs}</div>` : ''}
                            </td>
                            <td class="flex gap-10">
                                <button class="btn btn-ghost btn-sm" style="color: var(--card-blue);" 
                                    onclick='editStudentStatus("${student._id}", "${student.fullName.replace(/'/g, "\\'")}", ${JSON.stringify(student).replace(/'/g, "&apos;")})'>
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-ghost btn-sm" style="color: #ef4444;" onclick="deleteStudent('${student._id}', '${student.fullName.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error('Error loading students', err);
            }
        }

        async function loadDashboardData() {
            try {
                const sRes = await fetch('/api/all-students');
                const students = await sRes.json();
                document.getElementById('statTotalStudents').innerText = students.length;

                // Populate Report Batch Selector
                const batchSelect = document.getElementById('reportBatchSelect');
                const uniqueBatches = [...new Set(students.map(s => s.batch).filter(b => b))];
                batchSelect.innerHTML = '<option value="">All Batches</option>';
                uniqueBatches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.innerText = b;
                    batchSelect.appendChild(opt);
                });

                // Populate Report Student Selector
                const reportSelect = document.getElementById('reportStudentSelect');
                reportSelect.innerHTML = '<option value="">All Students</option>';
                students.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s._id;
                    opt.innerText = `${s.fullName} (${s.username})`;
                    reportSelect.appendChild(opt);
                });

                const aRes = await fetch('/api/attendance/today');
                const data = await aRes.json();

                const checkedIn = data.length;
                const checkedOut = data.filter(r => r.checkOutTime).length;
                const totalStudents = students.length;
                const pending = totalStudents - checkedIn;

                document.getElementById('statCheckedIn').innerText = checkedIn;
                document.getElementById('statCheckedOut').innerText = checkedOut;
                document.getElementById('statPending').innerText = pending >= 0 ? pending : 0;

                const tbody = document.querySelector('#attendanceTable tbody');
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-light); padding: 3rem;">No attendance marked for today yet.</td></tr>';
                } else {
                    data.forEach(rec => {
                        const row = document.createElement('tr');
                        const formatTime = (t) => t ? new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--';

                        row.innerHTML = `
                            <td>
                                <div class="text-bold" style="color: #1e293b;">${rec.studentId?.fullName || 'Member'}</div>
                                <div class="text-small text-muted text-mono" style="margin-top: 2px;">${rec.studentId?.username || '-'}</div>
                            </td>
                            <td>
                                <div class="flex gap-15" style="align-items: center;">
                                    <div class="flex gap-10 text-success text-bold"><i class="fas fa-sign-in-alt"></i> ${formatTime(rec.checkInTime)}</div>
                                    <div style="color: #e2e8f0; font-weight: 300;">|</div>
                                    <div class="flex gap-10 ${rec.checkOutTime ? 'text-danger' : 'text-muted'} text-bold"><i class="fas fa-sign-out-alt"></i> ${formatTime(rec.checkOutTime)}</div>
                                </div>
                            </td>
                            <td>
                                <div class="flex gap-10">
                                    ${rec.checkInPhoto ? `<div class="thumbnail-box"><img src="${rec.checkInPhoto}" class="thumbnail-img" onclick="openPhoto('${rec.checkInPhoto}')"><i class="fas fa-camera thumbnail-icon" style="color: var(--card-blue);"></i></div>` : ''}
                                    ${rec.checkOutPhoto ? `<div class="thumbnail-box"><img src="${rec.checkOutPhoto}" class="thumbnail-img" onclick="openPhoto('${rec.checkOutPhoto}')"><i class="fas fa-camera thumbnail-icon" style="color: #dc2626;"></i></div>` : ''}
                                </div>
                            </td>
                            <td><span class="badge-${rec.locationVerified ? 'verified' : 'failed'}"><i class="fas fa-location-dot"></i> ${rec.locationVerified ? 'Verified' : 'Invalid'}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (err) {
                console.error('Error loading dashboard');
            }
        }

        document.getElementById('addStudentForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            // Validate Phone
            let phoneInput = document.getElementById('parentPhone').value;
            let finalPhone = '';
            if (phoneInput) {
                finalPhone = formatPhoneNumber(phoneInput);
                if (!finalPhone) {
                    alert("Invalid WhatsApp Number.\nPlease enter 10 digits (e.g., 9876543210). Prefix +91 is added automatically.");
                    const btn = e.target.querySelector('button'); // Re-select btn just in case, though safe to use from closure
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            const payload = {
                fullName: document.getElementById('fullName').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                assignedShift: document.getElementById('assignedShift').value,
                batch: document.getElementById('batch').value || '',
                feeStatus: 'No Dues', // Default as field is removed
                recordStatus: document.getElementById('recordStatus').value || 'All Clear',
                dueDate: document.getElementById('dueDate').value || '',
                dueAmount: Number(document.getElementById('dueAmount').value) || 0,
                paidFees: Number(document.getElementById('paidFees').value) || 0,
                feeRemarks: document.getElementById('feeRemarks').value || '',
                pendingDocs: document.getElementById('pendingDocs').value || '',
                parentPhone: finalPhone
            };

            try {
                const res = await fetch('/api/students', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('Student registered successfully!');
                    document.getElementById('addStudentForm').reset();
                    loadDashboardData();
                    loadStudentsList();
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.message);
                }
            } catch (err) {
                alert('Connection error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }



        let currentReportData = []; // Store globally for CSV download

        async function loadReportPreview() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const batch = document.getElementById('reportBatchSelect').value;
            const studentId = document.getElementById('reportStudentSelect').value;
            const tbody = document.querySelector('#reportPreviewTable tbody');
            const downloadBtn = document.getElementById('downloadCSVBtn');

            if (!startDate || !endDate) { alert("Please select both dates."); return; }

            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem;"><i class="fas fa-spinner fa-spin"></i> Processing range data...</td></tr>';
            downloadBtn.style.display = 'none';

            try {
                const sRes = await fetch('/api/all-students');
                let students = await sRes.json();

                // Filter by Batch if selected
                if (batch) {
                    students = students.filter(s => s.batch === batch);
                }

                // If a specific student is selected, filter the student list
                if (studentId) {
                    students = students.filter(s => s._id === studentId);
                }

                const aRes = await fetch(`/api/attendance/range-report?startDate=${startDate}&endDate=${endDate}&studentId=${studentId}`);
                const data = await aRes.json();

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem;">No attendance records found for this month.</td></tr>';
                    return;
                }

                const activeDates = [...new Set(data.map(r => r.date))].sort().reverse(); // Show latest dates first
                tbody.innerHTML = '';
                currentReportData = [];

                activeDates.forEach(date => {
                    students.forEach(student => {
                        const rec = data.find(r => r.studentId?._id === student._id && r.date === date);
                        const displayDate = date.split('-').reverse().join('-');
                        const rowData = {
                            date: displayDate,
                            name: student.fullName,
                            username: student.username,
                            batch: student.batch || '-',
                            shift: student.assignedShift || 'morning',
                            status: rec ? 'PRESENT' : 'ABSENT',
                            inTime: rec && rec.checkInTime ? new Date(rec.checkInTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : (rec ? 'N/A' : 'ABSENT'),
                            outTime: rec && rec.checkOutTime ? new Date(rec.checkOutTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : (rec ? 'N/A' : 'ABSENT'),
                            gps: rec && rec.locationVerified ? 'YES' : 'NO'
                        };
                        currentReportData.push(rowData);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${rowData.date}</td>
                            <td><div style="font-weight: 700;">${student.fullName}</div><div style="font-size: 0.7rem; color: var(--text-light);">${student.username}</div></td>
                            <td><span style="text-transform: capitalize;">${student.batch || '-'}</span></td>
                            <td><span style="text-transform: capitalize;">${student.assignedShift || 'morning'}</span></td>
                            <td><span class="badge" style="background: ${rec ? '#dcfce7' : '#fee2e2'}; color: ${rec ? '#166534' : '#991b1b'}; width: 80px; text-align: center; display: inline-block;">${rowData.status}</span></td>
                            <td style="color: ${rec ? '#059669' : '#94a3b8'}; font-weight: 600;">${rowData.inTime}</td>
                            <td style="color: ${rec && rec.checkOutTime ? '#dc2626' : '#94a3b8'}; font-weight: 600;">${rowData.outTime}</td>
                            <td>
                                <div class="flex gap-10">
                                    ${rec && rec.checkInPhoto ? `<div class="thumbnail-box"><img src="${rec.checkInPhoto}" class="thumbnail-img" onclick="openPhoto('${rec.checkInPhoto}')"><i class="fas fa-camera thumbnail-icon" style="color: var(--card-blue); font-size: 0.5rem;"></i></div>` : ''}
                                    ${rec && rec.checkOutPhoto ? `<div class="thumbnail-box"><img src="${rec.checkOutPhoto}" class="thumbnail-img" onclick="openPhoto('${rec.checkOutPhoto}')"><i class="fas fa-camera thumbnail-icon" style="color: #dc2626; font-size: 0.5rem;"></i></div>` : ''}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });

                downloadBtn.style.display = 'block';
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem; color: #ef4444;">Failed to load report.</td></tr>';
            }
        }

        async function downloadExcel() {
            if (currentReportData.length === 0) return;

            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            // Prepare data for Excel
            const worksheetData = [
                ["Date", "Full Name", "Login ID", "Batch", "Shift", "Status", "Check-In Time", "Check-Out Time", "GPS Verified"]
            ];

            currentReportData.forEach(row => {
                worksheetData.push([
                    row.date,
                    row.name,
                    row.username,
                    row.batch,
                    row.shift,
                    row.status,
                    row.inTime,
                    row.outTime,
                    row.gps
                ]);
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Attendance Report");

            // Export to .xlsx
            XLSX.writeFile(wb, `vinnar_report_${startDate}_to_${endDate}.xlsx`);
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').style.display = 'none';
        }

        function openPhoto(url) {
            const modal = document.getElementById('viewPhotoModal');
            const img = document.getElementById('fullPhoto');
            img.src = url;
            modal.style.display = 'flex';
        }

        function closePhotoModal() {
            document.getElementById('viewPhotoModal').style.display = 'none';
        }

        async function editStudentStatus(id, name, s) {
            document.getElementById('editStudentId').value = id;
            document.getElementById('editFullName').value = s.fullName || name;
            document.getElementById('editDueDate').value = s.dueDate || '';
            document.getElementById('editDueAmount').value = s.dueAmount || 0;
            document.getElementById('editPaidFees').value = s.paidFees || 0;
            // feeStatus removed from UI
            document.getElementById('editFeeRemarks').value = s.feeRemarks || '';
            document.getElementById('editRecordStatus').value = s.recordStatus || 'All Clear';
            document.getElementById('editAssignedShift').value = s.assignedShift || 'morning';
            document.getElementById('editBatch').value = s.batch || '';
            document.getElementById('editPendingDocs').value = s.pendingDocs || '';
            document.getElementById('editParentPhone').value = s.parentPhone || '';
            document.getElementById('editPassword').value = ''; // Reset password field

            document.getElementById('editModalOverlay').style.display = 'flex';
        }

        document.getElementById('editStudentForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editStudentId').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            // Validate Phone
            let phoneInput = document.getElementById('editParentPhone').value;
            let finalPhone = '';
            if (phoneInput) {
                finalPhone = formatPhoneNumber(phoneInput);
                if (!finalPhone) {
                    alert("Invalid WhatsApp Number.\nPlease enter 10 digits (e.g., 9876543210). Prefix +91 is added automatically.");
                    const btn = e.target.querySelector('button');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            const payload = {
                fullName: document.getElementById('editFullName').value,
                dueDate: document.getElementById('editDueDate').value,
                dueAmount: Number(document.getElementById('editDueAmount').value),
                paidFees: Number(document.getElementById('editPaidFees').value),
                feeStatus: 'No Dues', // Default or preserve existing if logic allows (simplified to default here)
                feeRemarks: document.getElementById('editFeeRemarks').value,
                recordStatus: document.getElementById('editRecordStatus').value,
                assignedShift: document.getElementById('editAssignedShift').value,
                batch: document.getElementById('editBatch').value,
                pendingDocs: document.getElementById('editPendingDocs').value,
                parentPhone: finalPhone
            };

            const newPass = document.getElementById('editPassword').value;
            if (newPass) {
                payload.password = newPass;
            }

            try {
                const res = await fetch(`/api/students/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('Student updated successfully!');
                    closeEditModal();
                    loadStudentsList();
                    loadDashboardData();
                } else {
                    alert('Failed to update');
                }
            } catch (err) {
                alert('Connection error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        async function deleteStudent(id, name) {
            if (!confirm(`Are you sure you want to delete ${name}? This will also delete all their attendance records.`)) return;
            try {
                const res = await fetch(`/api/students/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Student deleted successfully');
                    loadStudentsList();
                    loadDashboardData();
                } else {
                    alert('Failed to delete student');
                }
            } catch (err) {
                alert('Connection error');
            }
        }

        document.getElementById('changePasswordForm').onsubmit = async (e) => {
            e.preventDefault();
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const statusDiv = document.getElementById('settingsStatus');
            const btn = e.target.querySelector('button');

            if (newPass !== confirmPass) {
                statusDiv.innerText = 'New passwords do not match!';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.style.display = 'block';
                return;
            }

            if (!user || !user.userId) {
                statusDiv.innerText = 'Session expired. Please login again.';
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating Passkey...';

            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.userId,
                        currentPassword: currentPass,
                        newPassword: newPass
                    })
                });

                const data = await res.json();
                statusDiv.innerText = data.message;
                statusDiv.style.display = 'block';

                if (res.ok) {
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    e.target.reset();
                } else {
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                }
            } catch (err) {
                statusDiv.innerText = 'Connection error. Try again.';
                statusDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Update Security Credentials';
            }
        };

        loadDashboardData();
        setInterval(() => {
            if (document.getElementById('sectionDashboard').classList.contains('active')) {
                loadDashboardData();
            }
        }, 10000);
    </script>
</body>

<!-- Deployed: 2026-01-28 for Vercel Update -->

</html>